<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8" />
<title>Slide-Player with Sprite</title>
<style>
  html,body{margin:0;height:100%}
  #root{position:relative;width:100%;height:100vh;overflow:hidden}
  #slide{width:90%;height:90%;border:1px solid gray}
  #char{position:absolute;right:-4vw;bottom:0;width:34vw;aspect-ratio:1/1;
        pointer-events:none;z-index:10}
</style></head><body>
<div id="root">
  <iframe id="slide"></iframe>
  <canvas id="char"></canvas>
</div>

<script type="module">

const slideFrame = document.getElementById('slide');
const slideWin   = slideFrame.contentWindow;
const canvas = document.getElementById('char');
const ctx = canvas.getContext('2d');

/* Hi-DPI */
function fit(){const dpr=window.devicePixelRatio||1;
  canvas.width=canvas.clientWidth*dpr;canvas.height=canvas.clientHeight*dpr;
  ctx.resetTransform();ctx.scale(dpr,dpr);} fit();addEventListener('resize',fit);

/* control sprite */
let sprite = null, curPose='idle';
const poses = {   // pose → [startFrame, endFrame] （0-based, inclusive）
  idle:[0,2], talk:[3,5], point:[6,8]
};
const cols=3, rows=3, fps=3, total=cols*rows;
let animStarted = false;

function frameRect(i){const w=sprite.width/cols,h=sprite.height/rows;
  return [(i%cols)*w, Math.floor(i/cols)*h, w, h];}

function startDraw(){
  let frame=0,last=0,interval=1000/fps;
  requestAnimationFrame(function loop(t){
    if(t-last>=interval){
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      const [s,e]=poses[curPose]||poses.idle;
      frame = (frame < s || frame > e)? s : frame+1>e? s : frame+1;
      const [sx,sy,sw,sh]=frameRect(frame);
      const margin = 10;
      ctx.drawImage(sprite,sx+margin,sy+margin,sw-margin*2,sh-margin*2,0,0,canvas.clientWidth,canvas.clientHeight);
      last=t;
    }
    requestAnimationFrame(loop);
  });
}

window.setSprite = async function (src) {
  try {
    const img = new Image();
    img.src = src;
    await img.decode();

    sprite = img;
    curPose = 'idle';

    if (!animStarted) {
      startDraw();
      animStarted = true;
    }
    console.log('[sprite] switched to', src);
  } catch (e) {
    console.error('[sprite] failed:', e);
  }
};

/* signal receiver */
window.playSignal = async ({type, ...p})=>{
  switch(type){
    case 'slideNext':
      slideWin.postMessage('slide-next', '*');
      break;
    case 'slidePrev':
      slideWin.postMessage('slide-prev', '*');
      break;
    case 'slideStep':
      slideWin.postMessage('slide-step', '*');
      break;
    case 'pose':      curPose=p.name||'idle'; break;
    case 'sprite':    await window.setSprite(p.src);       break;
  }
};
</script>
</body></html>
